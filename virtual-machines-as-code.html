<html><head><meta content="text/html; charset=utf-8" http-equiv="content-type"/><meta content="" name="description"/><meta content="" name="keywords"/><style>@charset "UTF-8";@import url("https://fonts.googleapis.com/css?family=Lato:300,400,900");html,body,div,span,h1,h2,h3,h4,p,a,i,ul,li,article,footer,header,nav,section{margin:0;padding:0;border:0;font-size:100%;font:inherit;vertical-align:baseline}article,footer,header,nav,section{display:block}body{line-height:1}ul{list-style:none}body{-webkit-text-size-adjust:none}*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}body{min-width:1200px}.container{margin-left:auto;margin-right:auto;width:1200px}.\31 1u{width:91.6666666667%}.\34 u{width:33.3333333333%}.row>*{float:left}.row:after{content:'';display:block;clear:both;height:0}.row:first-child>*{padding-top:0 !important}.row>*{padding-left:50px}.row{margin-left:-50px}body{background:#f3f6fa}body.loading *{-moz-animation:none !important;-webkit-animation:none !important;-o-animation:none !important;-ms-animation:none !important;animation:none !important}body{color:#1e2021;font-family:'Lato',sans-serif;font-size:15pt;font-weight:300;letter-spacing:.025em;line-height:1.75em}a{color:#007e6e;text-decoration:none;border-bottom:dotted 1px}p,ul{margin:0 0 2em 0}h1,h2,h3,h4{color:inherit;font-weight:300;line-height:1.75em;margin-bottom:1em;text-transform:uppercase}h2{font-size:1.5em;letter-spacing:.1em}h3{font-size:1.15em;letter-spacing:.025em}section.special{text-align:center}footer>:last-child{margin-bottom:0}::-webkit-input-placeholder{color:inherit;opacity:.5;position:relative;top:3px}:-moz-placeholder{color:inherit;opacity:.5}::-moz-placeholder{color:inherit;opacity:.5}:-ms-input-placeholder{color:inherit;opacity:.5}.icon{position:relative}.icon::before{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-family:FontAwesome;font-style:normal;font-weight:400}.icon,.feature{display:block;margin:0 0 1.5em 0;opacity:.45;text-align:center}.icon.feature::before{font-size:5em;line-height:1em}ul.buttons:last-child{margin-bottom:0}ul.buttons li{display:inline-block;padding:0 0 0 1.5em}ul.buttons li:first-child{padding:0}ul.buttons.vertical li{display:block;padding:1.5em 0 0 0}ul.buttons.vertical li:first-child{padding:0}.button{background:0;border:solid 1px;color:inherit;display:inline-block;font-size:.8em;font-weight:900;letter-spacing:2px;min-width:18em;padding:.75em 0;text-align:center;text-decoration:none;text-transform:uppercase}.button.fit{width:100%}.button.small{font-size:.7em;min-width:14em;padding:.5em 0}.wrapper{margin-bottom:5em;padding:5em}.wrapper.style1{padding:0}.wrapper.style2{background-color:#997394;background-image:url(../css/images/light-bl.svg),url(../css/images/light-br.svg);background-position:bottom left,bottom right;background-repeat:no-repeat,no-repeat;background-size:25em,25em;color:white}#header{background:white;box-shadow:0 1px 2px 0 rgba(0,0,0,.075);color:inherit;font-size:.8em;left:0;padding:1em 1.5em;position:fixed;top:0;width:100%;z-index:10000}#header h1{font-weight:900;margin:0}#header nav{letter-spacing:.075em;position:absolute;right:1.5em;text-transform:uppercase;top:.75em}#header nav ul li{display:inline-block;margin-left:1.5em}#header nav ul li>ul{display:none}#header nav ul li a{border:solid 1px transparent;color:inherit;display:inline-block;padding:0 .75em;text-decoration:none}#header nav ul li.submenu>a::before{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;font-style:normal;font-weight:400;margin-right:.65em}#header nav ul li.current>a{font-weight:900}#header.alt{-moz-animation:none;-webkit-animation:none;-o-animation:none;-ms-animation:none;animation:none;background:transparent;box-shadow:none;color:white;padding:2em 2.5em;position:absolute}#header.alt nav{right:2.5em;top:1.75em}@-moz-keyframes reveal-banner{0%{opacity:0}100%{opacity:1}}@-webkit-keyframes reveal-banner{0%{opacity:0}100%{opacity:1}}@-o-keyframes reveal-banner{0%{opacity:0}100%{opacity:1}}@-ms-keyframes reveal-banner{0%{opacity:0}100%{opacity:1}}@keyframes reveal-banner{0%{opacity:0}100%{opacity:1}}#banner{background-attachment:scroll,scroll,scroll,fixed;background-color:#945862;background-image:url(../images/robobanner.jpg);background-position:center;background-repeat:no-repeat,no-repeat,repeat,no-repeat;background-size:cover;color:white;padding:6em 0;text-align:center}#banner .inner{-moz-animation:reveal-banner 1s .25s ease-in-out;-webkit-animation:reveal-banner 1s .25s ease-in-out;-o-animation:reveal-banner 1s .25s ease-in-out;-ms-animation:reveal-banner 1s .25s ease-in-out;animation:reveal-banner 1s .25s ease-in-out;-moz-animation-fill-mode:forwards;-webkit-animation-fill-mode:forwards;-o-animation-fill-mode:forwards;-ms-animation-fill-mode:forwards;animation-fill-mode:forwards;background:rgba(52,27,43,.5);color:white;display:inline-block;opacity:0;padding:3em;text-align:center}#banner .inner header{display:inline-block;border-bottom:solid 2px;border-top:solid 2px;margin:0 0 2em 0;padding:3px 0 3px 0}#banner .inner header h2{border-bottom:solid 2px;border-top:solid 2px;font-size:2.5em;font-weight:900;letter-spacing:.2em;margin:0;padding-left:.05em;position:relative;text-transform:uppercase}#banner .inner p{letter-spacing:.1em;margin:0;text-transform:uppercase}#banner .inner footer{margin:2em 0 0 0}#main{background-image:url(../css/images/dark-tl.svg),url(../css/images/dark-tr.svg),url(../css/images/dark-bl.svg),url(../css/images/dark-br.svg);background-position:top left,top right,bottom left,bottom right;background-repeat:no-repeat;background-size:25em;padding:7em 0}#main>:last-child{margin-bottom:0}body.index #main{padding-top:5em}#banner .inner{opacity:1}.fab,.fas{-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased;display:inline-block;font-style:normal;font-variant:normal;text-rendering:auto;line-height:1}.fa-5x{font-size:5em}.fa-angle-down:before{content:"\f107"}.fa-aws:before{content:"\f375"}.fa-cloud:before{content:"\f0c2"}.fa-fly:before{content:"\f417"}.fab{font-family:Font Awesome\ 5 Brands}.fas{font-family:Font Awesome\ 5 Free}.fas{font-weight:900}</style><link href="./feeds/all.atom.xml" rel="alternate" title="hella labs-Feed" type="application/atom+xml"/><title>Virtual Machines as Code | hella labs</title><meta charset="utf-8"/><meta content="width=device-width" name="viewport"/></head><body class="loading"><header id="header"><h1 class="logo"><br/></h1><nav id="nav"><ul><li class="current"><a href="/index.html">Welcome</a></li><li><a href="./pages/about.html">About</a></li><li><a href="./pages/projects.html">Projects</a></li><li class="submenu"><span class="fas fa-angle-down"></span><a href="./">blog</a><ul><li class="active"><a href="./category/tech.html">tech</a></li></ul></li></ul></nav></header><article id="main"><header class="special container"><span class="icon"><span class="fas fa-code fa-5x"></span></span><h2><a href="virtual-machines-as-code.html">Virtual Machines as Code</a></h2><p class="tags"><a href="./tag/packer.html">#packer  </a><a href="./tag/ansible.html">#ansible  </a><a href="./tag/terraform.html">#terraform  </a><a href="./tag/devops.html">#devops  </a><a href="./tag/iaas.html">#iaas  </a> in <a href="./category/tech.html">tech</a></p><p>updated Sun 02 April 2023 by Ken</p></header><section class="wrapper style4 container"><div class="content"><section><p><p>Optimizing for determinism in virtual machines. This approach can be used to vend the same virtual machine image version in many formats e.g. VHD for Azure, Stack, and Hyper-V; OVA for VMware, VirtualBox; QCOW2 for KVM, and of course RAW.</p><div class="toc"><span class="toctitle">Table of contents:</span><ul><li><a href="#tldr">TL;DR</a></li><li><a href="#cloning-vs-code">Cloning vs Code</a></li><li><a href="#choosing-the-upstream-image">Choosing the Upstream Image</a></li><li><a href="#configuring-the-image">Configuring the Image</a></li><li><a href="#sealing-the-image">Sealing the Image</a></li><li><a href="#versioning-the-image">Versioning the Image</a></li><li><a href="#releasing-the-image">Releasing the Image</a></li><li><a href="#launching-from-the-image">Launching from the Image</a></li><li><a href="#upgrading-virtual-machines">Upgrading Virtual Machines</a></li></ul></div><p>An overview of the steps using Packer,Ansible, and AWS is given as an example.</p><h2 id="tldr">TL;DR</h2><ol><li>Choose a source control manager (SCM) that supports version tagging e.g. Git to house your code and perform the following actions inside the code repository.</li><li>Write a playbook declaring the desired OS configuration. To start, a single Ansible playbook file with several tasks may be sufficient. As your requirements become more complex you’ll employ Ansible roles which are reusable, parameterized configuration.</li><li>Write a Packer template.</li><li>Select the Packer “builder” for the desired VM image format e.g. amazon-ebs.</li><li>Select a trusted upstream image e.g. the Amazon Machine Image (AMI).</li><li>Select a Packer “provisioner” to invoke the configuration playbook e.g. “ansible”.</li><li>Commit the configuration playbook and Packer template to SCM.</li><li>Use a Git tag to “stamp” an immutable version string on the current SCM revision e.g. release-0.1.0.</li><li>Run Packer to “build” the new OS image in the specified format.</li></ol><h2 id="cloning-vs-code">Cloning vs Code</h2><p>The crucial aim here is a deterministic configuration of a virtual machine from source code. Cloning a disk image reproduces the good, the bad, and the unknown. The starting point for your VM image production pipeline is an upstream, vanilla, verifiable OS image; and the goal is to transform it with code into something useful.</p><h2 id="choosing-the-upstream-image">Choosing the Upstream Image</h2><p>The obvious choice is the checksum-verified install media from the OS maintainers, but it might make more sense to verify and trust a marketplace vendor, e.g. Rogue Wave Software on Azure, because they provide drivers and tunings for that platform.</p><p>If you require greater assurances or simply want more help with your image you may have more than one stage of upstream image transform that ultimately produces your functional image. One example of a multi-stage approach is to source the upstream image from a trusted vendor, and then to apply an OS hardening Ansible playbook. Alternatively, you could source a hardened OS image from the <a href="https://www.cisecurity.org/services/hardened-virtual-images/">Center for Internet Security</a>.</p><p>Either way, this is a time for diligence in risk management. You’ll want to be certain (enough) that you can verify the chain of custody of the upstream(s) with the rigor that is appropriate for your application.</p><h2 id="configuring-the-image">Configuring the Image</h2><p>Now that you have a trusted upstream image you’ll set about customizing it for your application. You’ll be glad you used a declarative configuration management system instead of shell scripts, and the fortunate soul that inherits your code too will be grateful. This means that the code that describes the configuration of your OS declares the desired end state e.g. “bind-utils is installed”, and the configuration system takes whatever actions are necessary to effect that state, and reports back whether this was a success with or without any change. In general, this approach offers a more principled approach which brings improved maintainability, strict error handling, debugging tools, and the like. To boot, you’ll probably learn some Python or Ruby along the way. It’s worth it.</p><h2 id="sealing-the-image">Sealing the Image</h2><p>It’s crucial to scrub and seal the OS before it becomes a reusable image. High-priority items include</p><ul><li>host SSH identities,</li><li>hardware addresses in network configuration,</li><li>deprovisioning any hypervisor agent e.g. waagent, and</li><li>removing any artifacts of the Packer provisioner(s) e.g. ansible-local requires the playbooks to be uploaded to the prototype VM.</li></ul><h2 id="versioning-the-image">Versioning the Image</h2><p>Before you run Packer to produce a new OS image, you’ll want to stamp the SCM repo that’s housing all this configuration with an immutable release version string e.g. <code>git tag release-0.1.0</code>. Ideally, this same string is stamped somewhere in the OS of the resultant image e.g. <code>/etc/release</code> and is also in the metadata e.g. entity tags of public cloud images like an AMI. Tagging is a feature of Packer’s “amazon-ebs” builder.</p><h2 id="releasing-the-image">Releasing the Image</h2><p>Most likely, this OS image you’re releasing will eventually become part of a release kit of many versioned components that together compose the full application stack. Importantly, releases are always immutable, and it is at this point that the OS image is “released” to and consumed by the stack. Any further features and fixes will be new release versions. Likewise, you’ll always be able to build an OS image with the current version by checking out the SCM tag on which it was originally built e.g. <code>git checkout release-0.1.0</code>.</p><h2 id="launching-from-the-image">Launching from the Image</h2><p>The new OS image should be referenced by its version string when launched by the application or a infrastructure-as-code provisioning tool like Terraform. This probably means some kind of lookup table that resolves the version string to the image ID. For example, if you used Packer’s “amazon-ebs” provisioner to assign an AMI tag “ImageVersion=release-0.1.0”, then you could find the AMI with that tag in a particular region with aws CLI.</p><div class="highlight"><pre><span></span><code>aws<span class="w"> </span>ec2<span class="w"> </span>describe-images<span class="w"> </span><span class="se">\</span>
<span class="w">   </span>–filters<span class="w"> </span><span class="nv">Name</span><span class="o">=</span>owner-id,Values<span class="o">=</span><span class="nv">$AWS_ACCOUNT_ID</span><span class="w"> </span><span class="se">\</span>
<span class="w">   </span>–filters<span class="w"> </span><span class="nv">Name</span><span class="o">=</span>tag:ImageVersion,Values<span class="o">=</span>release-0.1.0
</code></pre></div><h2 id="upgrading-virtual-machines">Upgrading Virtual Machines</h2><p>You’ll have to judge whether your application is best served by an in-place upgrade or turn-and-burn. The advantages of latter are enabled by a stack architecture that abstracts away persistence from the purview of the VM. If you can see a path forward to that end, then “Go West”. If you are forced to manage in-place upgrades then an aggressive always-latest-stable kind of strategy works best, and tools like Salt Stack are your friends.</p></p></section></div></section><section class="wrapper style1 container special"><div class="row"><div class="4u"><section><span class="icon feature"><span class="fas fa-cloud fa-5x"></span></span><header><a href="./cloudflare-dns-for-network-manager.html" rel="bookmark"><h3>CloudFlare DNS for Network Manager</h3></a></header><p>CloudFlare provides a performant recursive nameserver along with a promise to never surv</p><footer><ul class="buttons"><li><a class="button small" href="./cloudflare-dns-for-network-manager.html">Read More</a></li></ul></footer></section></div><div class="4u"><section><span class="icon feature"><span class="fab fa-fly fa-5x"></span></span><header><a href="./flyio-programmable-front-end.html" rel="bookmark"><h3>Fly.io Programmable Front-end</h3></a></header><p>In short, a programmable cloud delivery network (CDN) aka front-end like Fly.io is an API by which to configure the logical edge of an application stack. Fly.io</p><footer><ul class="buttons"><li><a class="button small" href="./flyio-programmable-front-end.html">Read More</a></li></ul></footer></section></div><div class="4u"><section><span class="icon feature"><span class="fas fa-video-slash fa-5x"></span></span><header><a href="./how-i-reclaimed-storage-space-in-google-photos-by-moving-all-my-videos.html" rel="bookmark"><h3>How I Reclaimed Storage Space in Google Photos By Moving All My Videos</h3></a></header><p>There's no easy way to find and delete a particular file or type of file in Google Photos, and there's no way to bulk delete with a tool or even the API. Here's</p><footer><ul class="buttons"><li><a class="button small" href="./how-i-reclaimed-storage-space-in-google-photos-by-moving-all-my-videos.html">Read More</a></li></ul></footer></section></div></div></section></article><footer id="footer"><ul class="icons"><li><span class="icon circle"><a class="fab fa-github fa-2x" href="https://github.com/qrkourier"><span class="label">github</span></a></span></li><li><span class="icon circle"><a class="fab fa-mastodon fa-2x" href="https://mastodon.online/@qrkourier"><span class="label">mastodon</span></a></span></li><li><span class="icon circle"><a class="fab fa-twitter fa-2x" href="https://twitter.com/qrkourier"><span class="label">twitter</span></a></span></li><li><span class="icon circle"><a class="fab fa-reddit fa-2x" href="https://www.reddit.com/user/bingnet"><span class="label">reddit</span></a></span></li><li><span class="icon circle"><a class="fab fa-keybase fa-2x" href="https://keybase.io/kourier"><span class="label">keybase</span></a></span></li></ul><span class="copyright">This work is licensed under a <a href="http://creativecommons.org/licenses/by/3.0/" rel="license">Creative Commons Attribution 3.0 Unported License</a>. <br/> Design: <a href="http://html5up.net">HTML5 UP</a>.</span></footer><!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]--><script src="/js/packed.js?9153b101"></script><link href="/css/pygment.css" rel="stylesheet"/><noscript><link href="/css/skel.css" rel="stylesheet"/><link href="/css/style.css" rel="stylesheet"/><link href="/css/style-noscript.css" rel="stylesheet"/></noscript><script src="//cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script><link crossorigin="anonymous" href="https://use.fontawesome.com/releases/v6.4.0/css/all.css" rel="stylesheet"/><link href="https://fonts.googleapis.com/css?family=Anonymous+Pro:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css"/><!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]--><!--[if lte IE 9]><link rel="stylesheet" href="/css/ie/v9.css" /><![endif]--></body></html>